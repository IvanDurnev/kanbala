{% extends 'base.html' %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col">
                <p class="m-0">Регламент: {{ regulation_version.parent_regulation().short_name }} <a href="#">Переименовать</a></p>
                <p>Версия {{ regulation_version.version_number }}</p>
            </div>
            <div class="col">
                <p class="m-0">Дата создания {{ regulation_version.created.strftime('%d.%m.%y %H:%M') }}</p>
                <p>Статус <em>{{ regulation_version.status }}</em></p>
            </div>
        </div>
        <div class="row">
            <form class="col" method="POST" action='/save_regulation_{{ regulation_version.id }}' id='editor'>
                <div class="form-group" id='headers'>
                    <div id='hdrs' class="p-3" style="background: lightgray">
                        <b>Шапка документа</b>
                        <div class="">
                            <label for='header_application'>Отметка о приложении</label>
                            <textarea class='form-control' name='header_application' id='header_application'>{{ data['header_application'] }}</textarea>
                        </div>
                        <div >
                            <label for='header_name'>Наименование приложения</label>
                            <textarea class='form-control' name='header_name'  id='header_name'>{{ data['header_name'] }}</textarea>
                            <label for='header_base_doc'>На основании нормативно-правовых актов</label>
                            <textarea class='form-control' name='header_base_doc'  id='header_base_doc' placeholder="вставьте ссылки на документы через пробел">{{ data['header_base_doc'] }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="p-3 main-text">
                    <p><b>Основной текст</b></p>
                    <a href="{{ url_for('main.editor_add_chapter', regulation_version_id=regulation_version.id) }}" class="btn btn-success">Добавить раздел</a>
                </div>
                <button class="btn btn-primary" form="editor" type="submit">Сохранить</button>
                <a class="btn btn-secondary" href="{{ url_for('main.index') }}">Закрыть</a>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        let data = {{ data|safe }};
        let pattern = /chapter_\d/;
        let chapters = [];
        for (let item in data) if (item.match(pattern)) chapters.push({'text': data[item]})
        let index = 0;
        for (let chapter in chapters) {
            index++
            let main_text_wrapper = $('.main-text')
            let chapter_wrapper_node = $(`<div class="chapter_${index}"></div>`)
            let chapter_header_node = $(`<p class="mb-0 mt-2">Раздел ${index}</p>`)
            let chapter_node = $(`<textarea class="form-control" id=chapter_name_${index} name="chapter_${index}" placeholder="Заголовок раздела">${chapters[chapter]['text']}</textarea>`)
            let add_paragraph_button = $(`<a class="btn btn-secondary ml-3" href="{{ url_for('main.add_paragraph', regulation_version_id=regulation_version.id, chapter_number='') }}${index}">Добавить пункт</a>`)

            let paragraph_pattern = new RegExp('paragraph_'+(Number(chapter)+1).toString()+'_\\d')
            let paragraphs = [];
            for (let item in data) {
                if (item.match(paragraph_pattern)) paragraphs.push({'text': data[item]})
            }

            chapter_wrapper_node.append(chapter_header_node, chapter_node, add_paragraph_button)
            main_text_wrapper.append(chapter_wrapper_node)

            for (let paragraph in paragraphs) {
                let paragraph_header_node = $(`<p class="ml-3 mb-0 mt-3" id=paragraph_name_${Number(paragraph)+1}_${Number(paragraph)+1}>Пункт ${Number(chapter)+1}.${Number(paragraph)+1}</p>`)
                let paragraph_node = $(`<textarea rows="15" class="form-control ml-3 mr-3" name=paragraph_${Number(chapter)+1}_${Number(paragraph)+1}>${paragraphs[paragraph]['text']}</textarea>`)
                chapter_wrapper_node.append(paragraph_header_node, paragraph_node)
            }
        }
    </script>
{% endblock %}